name: Build and Rollout Kanvas Reusable
on:
  workflow_call:
    inputs:
      branch:
        description: Repository branch to build.
        type: string
        default: master
    secrets:
      GH_ACCESS_TOKEN:
        required: true

jobs:
  build-and-release:
    name: Build and Rollout Kanvas
    outputs:
      meshery_version: ${{ steps.set-vars.outputs.MESHERY_VERSION }}
      meshery_extension_version: ${{ steps.set-vars.outputs.MESHERY_EXTENSION_VERSION }}
    env:
      RELEASE_CHANNEL: "kanvas"
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout meshery/meshery
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          path: "meshery"
          repository: meshery/meshery
          ref: ${{ inputs.branch }}
          sparse-checkout: |
             ui
             provider-ui
             server
             install/docker/**
             install/*
             /*
          sparse-checkout-cone-mode: false

      # - name: Checkout kanvas
      #   uses: actions/checkout@v5
      #   with:
      #     fetch-depth: 1
      #     sparse-checkout: |
      #       kanvas
      #     path: "kanvas"
      #     sparse-checkout-cone-mode: false

      - name: Fetch version scripts from meshery-extensions.
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          repository: layer5labs/meshery-extensions
          path: "meshery-extensions"
          fetch-depth: 1
          sparse-checkout: |
            kanvas
            build/get-meshery-version
            build/get-extension-version
          sparse-checkout-cone-mode: false

      - name: File system view
        run: |
          pwd;
          ls;
          tree  meshery-extensions;

      - name: Fetch Meshery and Extensions version
        id: set-vars
        run: |
          chmod +x ./meshery-extensions/build/get-meshery-version
          MESHERY_VERSION=$(./meshery-extensions/build/get-meshery-version)
          echo "MESHERY_VERSION=$MESHERY_VERSION" >> $GITHUB_ENV
          echo "MESHERY_VERSION=$MESHERY_VERSION" >> $GITHUB_OUTPUT

          chmod +x ./meshery-extensions/build/get-extension-version
          MESHERY_EXTENSION_VERSION=$(./meshery-extensions/build/get-extension-version)
          echo "MESHERY_EXTENSION_VERSION=$MESHERY_EXTENSION_VERSION" >> $GITHUB_ENV
          echo "MESHERY_EXTENSION_VERSION=$MESHERY_EXTENSION_VERSION" >> $GITHUB_OUTPUT

      - name: Docker login
        uses: azure/docker-login@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Configure kanvas distro
        # merges the custom kanvas distro at currentrepo/kanvas with the meshery repo checked out to
        # meshery/meshery directory to create a new meshery distro
        run: |
          #!/usr/bin/env bash
          set -euo pipefail
          
          echo "=== Before merge ==="
          ls -A
          echo
          echo "Contents of meshery/"
          ls -A meshery || echo "(empty or does not exist yet)"
          echo
          echo "Contents of ./meshery-extensions/kanvas/"
          ls -A ./meshery-extensions/kanvas
          
          echo
          echo "=== Merging everything from kanvas/ into meshery/ (including hidden files) ==="
          # This copies ALL files and directories, including hidden ones (.meshery, .git, etc.)
          cp -a ./meshery-extensions/kanvas/. ./meshery/
          
          echo
          echo "=== Updating capabilities.json with extension version ==="
          sed -i "s/REPLACE_WITH_PACKAGE_VERSION/${MESHERY_EXTENSION_VERSION:-unknown}/g" ./meshery/.meshery/provider/Layer5/capabilities.json
          
          echo
          echo "capabilities.json after substitution:"
          cat ./meshery/.meshery/provider/Layer5/capabilities.json
          
          echo
          echo "=== After merge ==="
          echo "Top-level in meshery/"
          ls -A meshery
          echo
          echo "Hidden .meshery directory contents:"
          ls -A meshery/.meshery
          echo
          echo "UI directory (example of deep path):"
          ls -A meshery/ui || echo "(not present)"

      - name: Docker build & tag
        working-directory: "./meshery"
        run: |
          DOCKER_BUILDKIT=1 docker build -f install/docker/Dockerfile --no-cache -t layer5/meshery:kanvas-latest --build-arg TOKEN=${{ secrets.GH_ACCESS_TOKEN }} --build-arg GIT_COMMITSHA=${GITHUB_SHA::8} --build-arg GIT_VERSION=${{ env.MESHERY_VERSION }} --build-arg RELEASE_CHANNEL=${RELEASE_CHANNEL} .

      - name: Bundle kanvas extension with the image
        working-directory: "./meshery-extensions"
        run: |
          wget https://github.com/layer5labs/meshery-extensions-packages/releases/download/${{ env.MESHERY_EXTENSION_VERSION }}/provider-meshery.tar.gz

          mkdir extensions-package
          tar xzf provider-meshery.tar.gz -C extensions-package
          mkdir -p provider/Layer5/${{ env.MESHERY_EXTENSION_VERSION }}
          mv extensions-package/provider provider/Layer5/${{ env.MESHERY_EXTENSION_VERSION }}

          ls;

          docker run -d --name meshery-tmp layer5/meshery:kanvas-latest

          docker cp -a ./provider/ meshery-tmp:/home/appuser/.meshery/

          docker container commit meshery-tmp layer5/meshery:kanvas-latest
      - name: Clean up checkout out repos
        run: |
          rm -rf ./meshery 
          rm -rf ./meshery-extensions
          
      - name: Docker tag & push
        run: |

          docker tag layer5/meshery:kanvas-latest layer5/meshery:kanvas-${GITHUB_SHA::8}
          docker tag layer5/meshery:kanvas-latest layer5/meshery:kanvas-${{ env.MESHERY_VERSION }}
          docker tag layer5/meshery:kanvas-latest layer5/meshery:kanvas-${{ env.MESHERY_EXTENSION_VERSION }}

          docker push layer5/meshery:kanvas-latest
          docker push layer5/meshery:kanvas-${GITHUB_SHA::8}
          docker push layer5/meshery:kanvas-${{ env.MESHERY_VERSION }}
          docker push layer5/meshery:kanvas-${{ env.MESHERY_EXTENSION_VERSION }}

      - name: Rollout Kanvas
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_BASTION_HOST }}
          username: ${{ secrets.OCI_BASTION_USERNAME }}
          key: ${{ secrets.OCI_BASTION_KEY }}
          port: 22
          script: |
            kubectl config use-context prod 
            kubectl set image deployment/kanvas kanvas=layer5/meshery:kanvas-${{env.MESHERY_EXTENSION_VERSION}} -n meshery-extensions

      - name: Send Email on Rollout Kanvas Release Failure
        if: ${{ failure() }}
        uses: dawidd6/action-send-mail@v6
        env:
          msg: ${{ env.reason != '' && env.reason || ' Rollout Kanvas Failure' }}
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: GitHub Actions - Rollout Kanvas Release Failure for ${{ env.MESHERY_EXTENSION_VERSION }}
          from: |
            "Meshery Extensions" <no-reply@meshery.io>
          to: |
            "Layer5 Support" <support@layer5.io>
          html_body: |
            <b>REPO:</b> ${{ github.repository }}<br />
            <b>WORKFLOW:</b> ${{ github.workflow }}<br />
            <b>JOB:</b> ${{ github.job }}<br />
            <b>REASON:</b> ${{ env.msg }}<br />
            <b>DETAILS:</b> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">{{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}</a><br />

  build-and-release-docker-extension:
    needs:
      - build-and-release
    runs-on: ubuntu-latest
    steps:
      - name: Create Release via GitHub API
        env:
          TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
          TAG: ${{ needs.build-and-release.outputs.meshery_version1- }}
          NAME: Kanvas Docker Extension ${{ needs.build-and-release.outputs.meshery_version }}
          BODY: See https://docs.layer5.io/kanvas/reference/releases/${{ needs.build-and-release.outputs.meshery_version }}
        run: |
          curl -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg tag "$TAG" --arg name "$NAME" --arg body "$BODY" \
                  '{tag_name: $tag, name: $name, body: $body, draft: false, prerelease: false}')" \
            https://api.github.com/repos/layer5io/kanvas-docker-extension/releases
