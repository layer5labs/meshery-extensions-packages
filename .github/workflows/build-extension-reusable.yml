name: Meshery Extension Build Reusable
on:
  workflow_call:
    inputs:
      pr_commit_sha:
        description: 'Commit SHA to build'
        required: true
        type: string
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
    secrets:
      NODE_VERSION:
        required: true
      GO_VERSION:
        required: true
      GH_ACCESS_TOKEN:
        required: true

jobs:
  comment-starting-point:
    runs-on: ubuntu-24.04
    env:
      GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
      PR_NUMBER: ${{ inputs.pr_number }}
    steps:
      - name: comment starting point
        uses: hasura/comment-progress@v2.3.0
        with:
          github-token: ${{ secrets.GH_ACCESS_TOKEN }}
          repository: "layer5labs/meshery-extensions"
          number: ${{ inputs.pr_number }}
          id: extension-test
          message: "Starting [Meshery Extensions Build](https://github.com/layer5labs/meshery-extensions-packages/actions/runs/${{ github.run_id }})..."
          recreate: true
          append : true
  build-meshery-extension:
    runs-on: ubuntu-24.04
    env:
      GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
      PR_NUMBER: ${{ inputs.pr_number }}
    steps:
      - name: Checkout for composite action
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            .github/actions/extension-comment
          sparse-checkout-cone-mode: false

      - name: Checkout Meshery-extensions code
        uses: actions/checkout@v4
        with:
          repository: layer5labs/meshery-extensions
          path: ./meshery-extensions
          fetch-depth: 1
          ref: ${{ inputs.pr_commit_sha }}
          token: ${{ secrets.GH_ACCESS_TOKEN }}

      - name: Checkout Meshery code
        uses: actions/checkout@v4
        with:
          repository: meshery/meshery
          path: ./meshery
          fetch-depth: 1
          token: ${{ secrets.GH_ACCESS_TOKEN }}

      - name: comment success
        if: success()
        uses: ./.github/actions/extension-comment
        with:
          message: ":heavy_check_mark: Meshery Extensions and Meshery repository checkouts complete."
      - name: comment failure
        if: failure()
        uses: ./.github/actions/extension-comment
        with:
          message: ":x: Meshery Extensions and Meshery repository checkouts failed."

      - name: Setup go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ secrets.GO_VERSION }}

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ secrets.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: 'meshery-extensions/meshmap/package-lock.json'

      - name: comment success
        if: success()
        uses: ./.github/actions/extension-comment
        with:
          message: ":heavy_check_mark: Go and Node.js setup complete."
      - name: comment failure
        if: failure()
        uses: ./.github/actions/extension-comment
        with:
          message: ":x: Go and Node.js setup failed."

      - name: Verify go.mod sync compatibility
        working-directory: meshery-extensions
        run: |
          make graphql-sync-err

      - name: comment success
        if: success()
        uses: ./.github/actions/extension-comment
        with:
          message: ":heavy_check_mark: GraphQL compatibility package check complete."
      - name: comment failure
        if: failure()
        uses: ./.github/actions/extension-comment
        with:
          message: ":x: GraphQL compatibility package check failed."

      - name: Validate MesheryUI Compatibility Package
        working-directory: ./meshery-extensions
        run: make kanvas-validate-mesheryui-compatibility

      - name: comment success
        if: success()
        uses: ./.github/actions/extension-comment
        with:
          message: ":heavy_check_mark: Kanvas compatibility package check complete."
      - name: comment failure
        if: failure()
        uses: ./.github/actions/extension-comment
        with:
          message: ":x: Kanvas compatibility package check failed."

      - name: Build Meshery Extension UI
        working-directory: ./meshery-extensions
        run: make kanvas-prod

      - name: Build Graphql Plugin
        working-directory: ./meshery-extensions
        run: make graphql

      - name: comment success
        if: success()
        uses: ./.github/actions/extension-comment
        with:
          message: ":heavy_check_mark: Meshery Extensions UI and GraphQL plugin build complete."
      - name: comment failure
        if: failure()
        uses: ./.github/actions/extension-comment
        with:
          message: ":x: Meshery Extensions UI and GraphQL plugin build failed."

      - name: Show runner tree
        run: tree /home/runner/.meshery

      - name: Relocate meshery-extension-ui
        run: mv /home/runner/.meshery/provider/Layer5/*/provider /home/runner/provider

      - name: Show runner tree
        run: tree /home/runner/ -L 3

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: meshery-extension-ui
          path: /home/runner/provider
          if-no-files-found: error

      - name: comment success
        if: success()
        uses: ./.github/actions/extension-comment
        with:
          message: ":heavy_check_mark: Meshery Extensions artifact upload complete."
      - name: comment failure
        if: failure()
        uses: ./.github/actions/extension-comment
        with:
          message: ":x: Meshery Extensions artifact upload failed."
